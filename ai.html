<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Packing Candy 3D Box</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1,user-scalable=no">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@900;700;600;500&display=swap" rel="stylesheet">
  <style>
    html,body {
      margin:0; padding:0; width:100vw; height:100vh; overflow:hidden;
      font-family:'Montserrat',Arial,sans-serif;
      background: #181a1a;
      user-select:none; -webkit-user-select:none;
      touch-action:manipulation;
    }
    body {
      min-height:100dvh;
      background:url('https://i.ibb.co/b5dqkL9N/candy-land-background-ei089uq3wekctn4y.jpg') center/cover no-repeat;
    }
    .bg-blur {
      position:fixed; left:0;top:0; width:100vw; height:100vh; z-index:1;
      backdrop-filter: blur(15px) brightness(1.08) contrast(1.12);
      background:rgba(255,255,255,0.11); pointer-events:none;
    }
    .app-wrap {
      position:fixed; left:0; top:0; width:100vw; height:100vh;
      display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:3;
      overflow:hidden;
      touch-action:manipulation;
    }
    .robot {
      position:fixed; left:50vw; top:48dvh; transform:translate(-50%,-50%);
      width:110px; height:110px; z-index:11;
      display:flex; flex-direction:column; align-items:center; pointer-events:none;
    }
    .robot-img {
      width:110px; height:110px; object-fit:contain; border-radius:50%;
      box-shadow:0 0 32px #41e6f222;
      background:rgba(255,255,255,0.12);
    }
    .robot-eyes-glow {
      position:absolute; left:50%; top:46.1%; width:37px; height:13px;
      transform:translate(-50%,-50%);
      border-radius:8px; z-index:2; pointer-events:none;
      box-shadow:0 0 19px 7px #1ae5b4,0 0 7px 2px #21ffc9;
      background:rgba(55,255,141,0.13);
      opacity:0; transition:opacity .36s;
    }
    .robot-eyes-glow.on { opacity:1; animation:eyesGlow 1.4s infinite alternate;}
    @keyframes eyesGlow { 100%{box-shadow:0 0 38px 19px #67fad7;} }
    .pick-row {
      position:fixed; width:100vw; left:0; display:flex; flex-direction:column; align-items:center; z-index:9;
      pointer-events:auto; user-select:none;
    }
    .pick-top { top:11dvh; }
    .pick-bot { bottom:12.3dvh;}
    .pick-card {
      background:#fff; border-radius:20px; box-shadow:0 7px 24px #b5f6fe18;
      min-width:140px; width:75vw; max-width:340px; min-height:140px; max-height:165px;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      margin:0 auto; cursor:pointer; position:relative; border:4px solid #fff;
      transition: transform .54s cubic-bezier(.59,1.3,.38,1.04), opacity .29s, border .18s, box-shadow .18s;
      opacity:0; pointer-events:none; z-index:10; user-select:none;
      will-change:opacity, transform;
    }
    .pick-card.in { opacity:1; pointer-events:auto; }
    .pick-card.selected { border:4px solid #22ff7e; box-shadow:0 7px 32px #15fa6332;}
    .pick-card.top { transform:translateX(99vw); }
    .pick-card.top.in { transform:translateX(0); }
    .pick-card.bot { transform:translateX(-99vw); }
    .pick-card.bot.in { transform:translateX(0); }
    .pick-card.out-up { opacity:0; transform:translateY(-90px) scale(0.91) rotate(-7deg);}
    .pick-card.out-down { opacity:0; transform:translateY(90px) scale(0.91) rotate(6deg);}
    .pick-img { width:97px; height:97px; object-fit:contain; border-radius:13px; pointer-events:none; }
    .final-grid {
      position:fixed; left:50vw; top:55.8dvh; transform:translate(-50%,-56%);
      display:grid; grid-template-columns:repeat(2,1fr); grid-gap:16px;
      z-index:18; width:92vw; min-width:0; min-height:170px; max-width:400px; opacity:0; transition:opacity .21s;
    }
    .final-grid.show { opacity:1; }
    .final-grid .pick-card {
      opacity:1; pointer-events:none; min-width:0; width:38vw; max-width:141px; height:66px; border-radius:13px;
      transition:opacity .28s, transform .47s cubic-bezier(.71,1.2,.36,1.09);
      margin:0 auto;
    }
    /* THREE.JS BOX CANVAS - поверх всего! */
    #box3dWrap {
      position:fixed; left:0; top:0; width:100vw; height:100vh;
      display:none; align-items:center; justify-content:center; z-index:9999 !important;
      background:rgba(0,0,0,0.09);
      backdrop-filter: blur(11px);
      pointer-events:none;
    }
    #box3dCanvas {
      width:95vw; height:56vw; max-width:470px; max-height:77vw; border-radius:17px; outline:none; background:transparent;
      display:block; margin:0 auto;
      box-shadow: 0 7px 48px #0005;
    }
    .done-block {
      position:fixed; left:50vw; top:50vh; transform:translate(-50%,-50%);
      display:flex; flex-direction:column; align-items:center; z-index:30000;
      opacity:0; pointer-events:none; transition:opacity .3s; min-width:180px;
    }
    .done-block.show { opacity:1; pointer-events:all;}
    .big-check { background:linear-gradient(135deg,#23e58d 65%,#1fb6fd 100%);
      border-radius:50%; width:82px; height:82px; display:flex; align-items:center; justify-content:center;
      box-shadow:0 7px 38px #63f0b92c, 0 0 0 18px #e0fff6; animation:pop .17s;}
    .big-check svg { width:46px; height:46px;}
    .success-text { font-size:1.11rem; font-weight:900; margin-top:13px; color:#23a768; text-align:center; letter-spacing:.01em; text-shadow:0 2px 10px #23e58d2c;}
    @keyframes pop { 0%{transform:scale(.85); opacity:.2;} 100%{transform:scale(1);opacity:1;} }
    ::-webkit-scrollbar{display:none;}
  </style>
</head>
<body>
<div class="bg-blur"></div>
<div class="app-wrap" id="appWrap">
  <div class="robot" id="robot">
    <img src="https://i.ibb.co/M5NTbkRD/Chat-GPT-Image-16-2025-14-16-44.png" class="robot-img" id="robotImg">
    <div class="robot-eyes-glow" id="robotGlow"></div>
  </div>
  <div class="pick-row pick-top" id="pickTop"></div>
  <div class="pick-row pick-bot" id="pickBot"></div>
  <div class="final-grid" id="finalGrid"></div>
  <div id="box3dWrap"><canvas id="box3dCanvas"></canvas></div>
  <div class="done-block" id="doneBlock" style="display:none;">
    <div class="big-check">
      <svg width="66" height="66" viewBox="0 0 50 50">
        <polyline points="14,27 24,37 39,14" fill="none" stroke="#fff" stroke-width="7" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>
    <div class="success-text">Items are on the way!</div>
  </div>
</div>
<!-- GSAP -->
<script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
<!-- Three.js -->
<script src="https://cdn.jsdelivr.net/npm/three@0.153.0/build/three.min.js"></script>
<script>
  // --- ВЫБОР ТОВАРОВ ---
  const rounds = [
    [
      {img:'https://i.ibb.co/fYyhV8rF/1.png'},
      {img:'https://i.ibb.co/hFFS8XBs/2.png'}
    ],
    [
      {img:'https://i.ibb.co/gZLKNBq1/3.png'},
      {img:'https://i.ibb.co/4ZLch1mk/4.png'}
    ]
  ];
  const finalItems = [
    {img:'https://i.ibb.co/hFFS8XBs/2.png'},
    {img:'https://i.ibb.co/gZLKNBq1/3.png'},
    {img:'https://i.ibb.co/4ZLch1mk/4.png'},
    {img:'https://i.ibb.co/fYyhV8rF/1.png'},
  ];
  let round = 0, chosen = [], canPick = true;
  const pickTop = document.getElementById('pickTop');
  const pickBot = document.getElementById('pickBot');
  const robotGlow = document.getElementById('robotGlow');
  const robot = document.getElementById('robot');
  function showPair() {
    pickTop.innerHTML = pickBot.innerHTML = '';
    robotGlow.className = "robot-eyes-glow";
    canPick = true;
    let pair = rounds[round];
    pickTop.innerHTML = `<div class="pick-card top" id="pickCard0"><img src="${pair[0].img}" class="pick-img"></div>`;
    pickBot.innerHTML = `<div class="pick-card bot" id="pickCard1"><img src="${pair[1].img}" class="pick-img"></div>`;
    gsap.set("#pickCard0", {opacity:0, x:window.innerWidth*1.1, pointerEvents:"none"});
    gsap.set("#pickCard1", {opacity:0, x:-window.innerWidth*1.1, pointerEvents:"none"});
    gsap.to("#pickCard0", {
      opacity:1, x:0, duration:.52, ease:"expo.out",
      onComplete:()=>{document.getElementById('pickCard0').style.pointerEvents = "auto";}
    });
    setTimeout(()=>{ 
      gsap.to("#pickCard1", {
        opacity:1, x:0, duration:.52, ease:"expo.out",
        onComplete:()=>{document.getElementById('pickCard1').style.pointerEvents = "auto";}
      });
    },170);
    setTimeout(()=>{
      document.getElementById('pickCard0').onclick = ()=>pickCard(0);
      document.getElementById('pickCard1').onclick = ()=>pickCard(1);
    },520);
  }
  function pickCard(idx) {
    if(!canPick) return;
    canPick = false;
    robotGlow.className = "robot-eyes-glow on";
    document.getElementById('pickCard'+idx).classList.add('selected');
    chosen.push(rounds[round][idx]);
    gsap.to("#pickCard0", {opacity:0, y:-85, duration:.44, delay:.19, ease:"power1.in"});
    gsap.to("#pickCard1", {opacity:0, y:85, duration:.44, delay:.19, ease:"power1.in"});
    setTimeout(()=>{
      if(round<rounds.length-1){ round++; showPair(); } else { showFinal(); }
    },640);
  }
  function showFinal() {
    pickTop.innerHTML = pickBot.innerHTML = "";
    robot.style.top = "14dvh";
    robotGlow.className = "robot-eyes-glow on";
    const grid = document.getElementById('finalGrid');
    grid.innerHTML = finalItems.map(item => `<div class="pick-card in"><img src="${item.img}" class="pick-img"></div>`).join('');
    grid.classList.add('show');
    setTimeout(()=>{box3dAnim();},820);
  }

  // --------- THREE.JS PREMIUM BOX ----------
  let boxScene, boxCamera, boxRenderer, boxMesh, boxLid, boxFrame, itemsMeshes=[];
  function box3dAnim() {
    document.getElementById('box3dWrap').style.display = "flex";
    // Коробка всегда по центру и Z-index поверх всех (CSS выше!)
    if(!boxScene){
      const canvas = document.getElementById('box3dCanvas');
      const w = canvas.clientWidth, h = canvas.clientHeight;
      boxScene = new THREE.Scene();
      boxCamera = new THREE.PerspectiveCamera(43, w/h, 0.1, 100);
      boxCamera.position.set(2,2.25,5.3);
      boxScene.add(new THREE.AmbientLight(0xffffff, 0.82));
      let dir = new THREE.DirectionalLight(0xfff8dc,0.7); dir.position.set(2,6,7); boxScene.add(dir);
      // -- Box (body)
      const boxMat = new THREE.MeshStandardMaterial({color:0xecd39b, roughness:0.36, metalness:0.16});
      boxMesh = new THREE.Mesh(new THREE.BoxGeometry(2,1,2), boxMat); boxMesh.position.set(0,0,0); boxScene.add(boxMesh);
      // -- Lid
      const lidMat = new THREE.MeshStandardMaterial({color:0xd2b073, roughness:0.21, metalness:0.18});
      boxLid = new THREE.Mesh(new THREE.BoxGeometry(2,0.13,2.02), lidMat);
      boxLid.position.set(0,0.57,0); boxLid.rotation.x = Math.PI/2; boxScene.add(boxLid);
      // -- Shadow
      const plane = new THREE.Mesh(new THREE.PlaneGeometry(6,6), new THREE.MeshStandardMaterial({color:0x000000,transparent:true,opacity:.13}));
      plane.position.set(0,-.51,0); plane.rotation.x=-Math.PI/2; boxScene.add(plane);
      // -- Renderer
      boxRenderer = new THREE.WebGLRenderer({canvas,alpha:true,antialias:true});
      boxRenderer.setClearColor(0x000000,0); boxRenderer.setSize(w,h);
    }
    boxMesh.rotation.y = 0.7;
    boxLid.rotation.x = Math.PI/2;
    // -- Items (sprites): добавим как плоскости с PNG
    itemsMeshes = [];
    const texLoader = new THREE.TextureLoader();
    finalItems.forEach((item,i)=>{
      texLoader.load(item.img,tex=>{
        let mat=new THREE.MeshBasicMaterial({map:tex,transparent:true});
        let mesh=new THREE.Mesh(new THREE.PlaneGeometry(0.62,0.62),mat);
        mesh.position.set(-1.2+1.2*(i%2),1.45+(i>1?0.38:0),0.55-0.99*(i>1?1:0));
        mesh.rotation.z=(Math.random()-.5)*.6;
        mesh.userData={targetY:-.13+Math.random()*.2,done:false};
        itemsMeshes.push(mesh); boxScene.add(mesh);
      });
    });
    let t=0;
    function anim(){
      t+=1/60;
      // Box lid open->close
      if(t<2.1) boxLid.rotation.x=Math.PI/2-Math.sin(t/2.1)*1.12;
      else boxLid.rotation.x=Math.PI/2-Math.sin(2)*1.12+.17-Math.max(0,(t-2)*0.35);
      // Box rotate
      boxMesh.rotation.y = boxLid.rotation.y = Math.sin(t/2)*.07+0.55;
      // Drop items
      itemsMeshes.forEach((sp,i)=>{
        if(!sp.userData.done && t>0.6+i*0.47){
          sp.position.y += (sp.userData.targetY-sp.position.y)*.13+.023;
          sp.position.x += (0-sp.position.x)*.12;
          if(Math.abs(sp.position.y-sp.userData.targetY)<.02){
            sp.position.y = sp.userData.targetY; sp.userData.done=true;
          }
          sp.material.opacity = Math.max(0, 1-((t-1.3-i*0.41)*0.7));
        }
      });
      boxRenderer.render(boxScene,boxCamera);
      if(t<5.2) requestAnimationFrame(anim);
      else {
        // Close lid
        gsap.to(boxLid.rotation, {x:Math.PI/2, duration:.73, ease:"power2.in"});
        gsap.to(boxMesh.rotation, {z:0.11, y:0.7, repeat:1, yoyo:true, duration:0.23});
        setTimeout(()=>{
          document.getElementById('box3dWrap').style.display="none";
          document.getElementById('finalGrid').classList.remove('show');
          showDone();
        },970);
      }
    }
    anim();
  }
  function showDone() {
    const done = document.getElementById('doneBlock');
    done.style.display='flex'; setTimeout(()=>{ done.classList.add('show'); },14);
    setTimeout(()=>{
      done.classList.remove('show');
      setTimeout(()=>{
        done.style.display='none';
        robot.style.top="48dvh"; round=0; chosen=[];
        showPair();
      },400);
    },2450);
  }
  showPair();
</script>
</body>
</html>
